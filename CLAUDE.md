# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 构建命令

### 基本构建流程
```bash
# 创建构建目录
mkdir -p build && cd build

# 配置项目（需要 CMake 3.27+）
cmake ..

# 编译项目
make -j$(nproc)

# 可执行文件将在 build/ 目录中生成
```

### 测试可执行文件
项目会生成以下测试程序：
- `testmain` - 主要测试程序，包含综合演示
- `testlib1` - 测试库1
- `testlib2` - 测试库2

### 平台支持
构建系统通过 cmake-env 配置支持多平台：
- x64 (cmake-env/x64-env.cmake)
- aarch64 (cmake-env/aarch64-env.cmake)
- arm (cmake-env/arm.cmake)

### 编译选项
- 使用 C++17 标准
- 启用 log4cplus 日志库 (`-DUSE_SDKLOG=1`)
- 包含安全编译选项（栈保护、符号隐藏等）

## 代码架构

### 总体结构
ArrowLib 是一个纯头文件的 C++17 模板元编程库，按功能模块组织：

#### 核心模块 (arrow/)
- **typelist/** - 模板元编程工具
  - 编译时类型列表操作、静态数组、静态映射、静态字符串
  - 类型名反射和枚举名提取
  - 整数序列生成工具
- **pattern/** - 设计模式实现
  - 单例、观察者、工厂、状态机、责任链模式
- **task/** - 任务管理和并发编程
  - 无锁队列（MPSC、通用队列）
  - 线程池和任务调度器
- **other/** - 实用工具模块
  - 自定义分配器的对象池
  - 运行时测量、类型计数工具
  - 动态库加载、元组操作
- **log/** - 日志抽象层
  - 支持 log4cplus、标准输出或空实现
  - 通过编译标志 `-DUSE_SDKLOG=1` 控制
- **timer/** - 定时器工具
- **format/** - 格式化工具

#### 外部依赖
- **nlohmann/** - JSON 库集成 (json.hpp, json_arrow.hpp)

### 关键设计原则
1. **纯头文件库** - 所有功能都在头文件中，便于集成
2. **模板元编程** - 大量使用编译时计算
3. **平台抽象** - 通过 cmake 配置支持跨平台
4. **模块化设计** - 各模块独立，可单独使用

### 版本管理
版本信息自动从 Git 元数据生成到 `version.h`：
- Git 哈希、分支、标签信息
- 构建时间戳
- 提交索引计数器

### 测试结构
测试按功能组织在 `test/` 目录，包含专门的 CMake 配置：
- `test/testmain/demo/` 中的综合演示
- `test/test_enum2/` 和 `test/test_enum3/` 枚举转换测试
- 性能测试功能
- 无锁数据结构验证

### 单独测试构建
对于特定的测试项目（如 test_enum3），可以单独构建：
```bash
# 进入测试目录
cd test/test_enum3

# 创建构建目录
mkdir -p build && cd build

# 配置和构建
cmake .. && make

# 运行测试
./test_enum3_exec
```

### 开发工作流
1. **主项目构建** - 使用根目录的 CMakeLists.txt 构建整个项目
2. **单个测试** - 在相应的 test 子目录中单独构建和测试
3. **编译器支持** - 项目支持 GCC 7+、Clang 和 MSVC，默认使用 C++17 标准

### 关键技术特点
- **编译时计算** - 大量使用 constexpr 和模板元编程
- **无锁并发** - 多种无锁数据结构实现（注意：存在已知 ABA 问题需要解决）
- **枚举反射** - 编译时枚举名称提取和字符串转换
- **跨平台兼容** - 支持 x64、aarch64、arm 架构
- **安全编译** - 启用栈保护、符号隐藏等安全选项

### 已知问题
参考 `重构建议.md` 文件了解当前代码库的关键问题：
- 无锁队列存在 ABA 问题需要修复
- 单例模式线程安全需要改进
- 对象池存在内存泄漏风险

### 调试和优化
- 使用 `-DUSE_SDKLOG=1` 启用详细日志
- 版本信息自动从 Git 生成到 `version.h`
- 支持 AddressSanitizer（在 cmake 中取消注释相关行）

## 开发指导

### 核心设计理念
ArrowLib 遵循现代 C++ 设计原则：
- **纯头文件库** - 所有实现都在头文件中，便于集成和内联优化
- **编译时计算** - 尽可能在编译时完成工作，减少运行时开销
- **模板元编程** - 使用 TMP 技术实现类型安全和性能优化
- **零成本抽象** - 抽象不应该带来运行时开销

### 添加新功能的指导
1. **头文件组织** - 按功能模块放置在 `arrow/` 相应子目录
2. **命名约定** - 使用一致的命名风格，参考现有代码
3. **模板设计** - 优先使用编译时计算，避免运行时开销
4. **异常安全** - 确保强异常安全保证，使用 RAII 管理资源
5. **测试覆盖** - 在 `test/` 目录添加相应的测试用例

### 关键文件说明
- `arrow/arrow.h` - 主要入口头文件
- `arrow/define.h` - 全局宏定义
- `arrow/log.h` - 日志抽象层
- `version.h` - 自动生成的版本信息（不要手动修改）
- `重构建议.md` - 当前代码库的已知问题和改进建议

### 常见问题排查
1. **编译错误** - 检查 C++17 支持，确保使用兼容的编译器版本
2. **链接错误** - 确认平台配置正确，检查 cmake-env 设置
3. **运行时问题** - 启用日志输出，检查无锁数据结构的使用是否正确
4. **性能问题** - 使用 Release 构建，检查模板实例化是否过度